if (!require("pacman")) install.packages("pacman")
pacman::p_load(conflicted, here, sqldf, stringr)

library(sqldf)
library(dplyr)


container_analysis_result = read.csv(here::here("data","container_analysis_result_for_five_images.csv"), header = TRUE, sep = ",")
container_analysis_result = container_analysis_result[which(container_analysis_result$os == "debian"),]


vulnerabilities = read.csv(here::here("data","vulnerabilities.csv"), header = TRUE, sep = ",")
vulnerabilities<-unique(vulnerabilities)

vulnerabilities %>%
  group_by(urgency) %>%
  summarise(n = length(unique(cve))/length(unique(vulnerabilities$cve)))

vulnerabilities$severity<-'low'
vulnerabilities[which(vulnerabilities$urgency=='high'),]$severity = "high"

vulnerabilities$high = 0
vulnerabilities[which(vulnerabilities$urgency=='high'),]$high = 1

vulnerabilities$not_high = 0
vulnerabilities[which(vulnerabilities$urgency!='high'),]$not_high = 1

libCount<-container_analysis_result %>% 
  group_by(image, parent_image) %>% 
  summarize(lib_count=length(unique(library)))

vulnerabilities<-vulnerabilities %>% 
  group_by(image) %>%
  summarize(total_high_vuls = sum(high), total_not_high_vuls=sum(not_high))

image_vuls_count=merge(x=vulnerabilities, y=libCount, by.x=c("image"), by.y=c("image"))

container_analysis_detail = read.csv(here::here("data","metadata_for_five_images_samples.csv"), header = TRUE, sep = ",")


image_details = sqldf("select container_analysis_detail.*, image_vuls_count.parent_image, image_vuls_count.lib_count,
      image_vuls_count.total_high_vuls, image_vuls_count.total_not_high_vuls 
      from container_analysis_detail inner join image_vuls_count on
      container_analysis_detail.image = image_vuls_count.image")

image_details$image = as.character(image_details$image)
image_details$parent_image = as.character(image_details$parent_image)

image_details$total_vuls = image_details$total_high_vuls + image_details$total_not_high_vuls

write.csv(image_details, here::here("data","image_detail_with_vulnerabilities.csv"), row.names = FALSE)


test_results = data.frame(image_type = character(), vull_vs_pull = numeric(), vull_vs_star = numeric())

for (parent_image in unique(image_details$parent_image)) {
  
  print(parent_image)
  parent_image = as.character(parent_image)
  
  community_images = image_details[image_details$parent_image == parent_image
                                   & 
                                     image_details$image != image_details$parent_image, ]
  
  official_image = image_details[image_details$parent_image == parent_image
                                 &
                                   image_details$image == image_details$parent_image, ]
  
  #all_vuls_pull_count_test_result = wilcox.test(
  #  community_images$pull_count,
  #  community_images$total_vuls,
  #  paired = TRUE,
  #  alternative = "two.sided"
  #)
  all_vuls_pull_count_test_result = cor.test(community_images$pull_count,
                                             community_images$total_vuls,
                                             method = c("spearman")
  )
  
  all_vuls_star_count_test_result = cor.test(community_images$star_count,
                                             community_images$total_vuls,
                                             method = c("spearman")
  )
  
  #all_vuls_star_count_test_result = wilcox.test(
  #  community_images$star_count,
  #  community_images$total_vuls,
  #  paired = TRUE,
  #  alternative = "two.sided"
  #)
  
  test_results = rbind(
    test_results,
    data.frame(image_type = parent_image, vull_vs_pull = all_vuls_pull_count_test_result$estimate, 
               vull_vs_star=all_vuls_star_count_test_result$estimate)
  )
  
}

write.csv(test_results, here::here("data","vul_popularity_test_results.csv"))


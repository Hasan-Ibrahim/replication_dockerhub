if (!require("pacman")) install.packages("pacman")
pacman::p_load(conflicted, here, sqldf, stringr)

vulnerabilities = read.csv(here::here("data","vulnerabilities.csv"), header = TRUE, sep = ",")
vulnerabilities$X = NULL

vulnerabilities<-unique(vulnerabilities)

vulnerabilities$parent_image=''
vulnerabilities[grep('*java$', vulnerabilities$image),]$parent_image='java'
vulnerabilities[grep('*cassandra$', vulnerabilities$image),]$parent_image='cassandra'
vulnerabilities[grep('*mysql$', vulnerabilities$image),]$parent_image='mysql'
vulnerabilities[grep('*mysqldb$', vulnerabilities$image),]$parent_image='mysql'
vulnerabilities[grep('*mongo$', vulnerabilities$image),]$parent_image='mongo'
vulnerabilities[grep('*mongodb$', vulnerabilities$image),]$parent_image='mongo'
vulnerabilities[grep('*nginx$', vulnerabilities$image),]$parent_image='nginx'

vulnerabilities$parent_image = as.character(vulnerabilities$parent_image)
vulnerabilities$image = as.character(vulnerabilities$image)

official_image_vuls = vulnerabilities[vulnerabilities$image == vulnerabilities$parent_image,]
community_image_vuls = vulnerabilities[vulnerabilities$image != vulnerabilities$parent_image,]

most_occured_vuls_in_official_image = sqldf("select parent_image, cve, urgency, count(cve) as occurance from official_image_vuls 
                                            group by parent_image, cve, urgency order by occurance desc")

most_occured_vuls_in_community_image = sqldf("select parent_image, cve, urgency, count(cve) as occurance from community_image_vuls 
                                            group by parent_image, cve, urgency order by occurance desc")


unique_parent_images = unique(container_analysis_result$parent_image)

official_image_having_different_vuls = data.frame()
for(parent_image in unique_parent_images){
  community_image = vulnerabilities[vulnerabilities$parent_image == parent_image
                                    & vulnerabilities$parent_image != vulnerabilities$image,]
  official_image = vulnerabilities[vulnerabilities$parent_image == parent_image 
                                   & vulnerabilities$parent_image == vulnerabilities$image,]
  #print(nrow(sqldf("select * from official_image where vul_name not in (select distinct vul_name from community_image)")))
  if(nrow(official_image) > 0){
    official_image_having_different_vuls = rbind(official_image_having_different_vuls, 
                                                 sqldf("select * from official_image where cve not in (select distinct cve from community_image)"))
  }
}


x<-vulnerabilities %>%
  group_by(cve, parent_image) %>%
  summarize(c = length(unique(image)))

summary(x)

n_cass<-length(unique(vulnerabilities[which(vulnerabilities$parent_image=="cassandra"),]$image))
n_java<-length(unique(vulnerabilities[which(vulnerabilities$parent_image=="java"),]$image))
n_mongo<-length(unique(vulnerabilities[which(vulnerabilities$parent_image=="mongo"),]$image))
n_mysql<-length(unique(vulnerabilities[which(vulnerabilities$parent_image=="mysql"),]$image))
n_nginx<-length(unique(vulnerabilities[which(vulnerabilities$parent_image=="nginx"),]$image))

x<-x[which(!is.na(x$cve)),]

x$nbreImages=0
x[which(x$parent_image=="cassandra"),]$nbreImages = n_cass
x[which(x$parent_image=="java"),]$nbreImages = n_java
x[which(x$parent_image=="mongo"),]$nbreImages = n_mongo
x[which(x$parent_image=="mysql"),]$nbreImages = n_mysql
x[which(x$parent_image=="nginx"),]$nbreImages = n_nginx



ggplot(data = x
       , aes(x = parent_image, y = c)) +
  geom_boxplot() +
  theme_gray(base_size = 16)+
  ylab("Number of images") + 
  xlab("") +
  theme(axis.text=element_text(size=24), text = element_text(size=24))

medians<-x %>% 
  group_by (parent_image) %>% 
  summarize (med = median(c), ma = max(c))


# cve that are present in all the images:
x$per<-x$c/x$nbreImages
nrow(x[which(x$per==1),])

x[which(x$per==1),] %>%
  group_by(parent_image) %>%
  summarize(length(unique(cve)))

# cve that are shared between different systems

y<-x[which(x$per==1),] %>%
  group_by(cve) %>%
  summarize(length(unique(parent_image)))
y[which(y$`length(unique(parent_image))`==5),]



